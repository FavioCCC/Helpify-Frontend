<main class="wrap">
  <div class="back-btn" (click)="volver()" title="Volver" aria-label="Volver">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M15 18l-6-6 6-6"></path>
    </svg>
  </div>

  <h1 class="title">DONAR</h1>

  <!-- Formulario reactivo -->
  <section class="panel" [formGroup]="form">
    <div class="grid">
      <div>
        <h3 class="section-title">Monto</h3>

        <!-- Chips de monto -->
        <div class="chips" id="chips">
          <div class="chip" (click)="selectChip(10)"  [class.active]="form.get('monto')?.value === 10">S/ 10</div>
          <div class="chip" (click)="selectChip(20)"  [class.active]="form.get('monto')?.value === 20">S/ 20</div>
          <div class="chip" (click)="selectChip(50)"  [class.active]="form.get('monto')?.value === 50">S/ 50</div>
          <div class="chip" (click)="selectChip(100)" [class.active]="form.get('monto')?.value === 100">S/ 100</div>
        </div>

        <div class="field">
          <label for="otro">Otro monto:</label>
          <input
            id="otro"
            type="text"
            inputmode="decimal"
            placeholder="S/ 0"
            [value]="form.get('monto')?.value ?? ''"
            (input)="onOtroMontoChange($event)" />
          <small
            *ngIf="form.get('monto')?.invalid && (form.get('monto')?.touched || form.get('monto')?.dirty)"
            style="color:#a12626;font-weight:700">
            {{ errors?.monto || 'Ingresa un monto válido (mín. S/ 1)' }}
          </small>
        </div>

        <h3 class="section-title">Método de pago</h3>
        <div class="pay-tabs">
          <div class="tab active" id="tabTarjeta">Tarjeta</div>
        </div>

        <div class="field">
          <label for="titular">Nombre de la tarjeta:</label>
          <input
            id="titular"
            type="text"
            placeholder="Como aparece en la tarjeta"
            formControlName="nombretitular" />
          <small
            *ngIf="form.get('nombretitular')?.invalid && (form.get('nombretitular')?.touched || form.get('nombretitular')?.dirty)"
            style="color:#a12626;font-weight:700">
            {{ errors?.titular || 'Ingresa el nombre del titular' }}
          </small>
        </div>

        <div class="row-3">
          <div class="field">
            <label for="numero">Número de tarjeta:</label>
            <input
              id="numero"
              type="text"
              inputmode="numeric"
              placeholder="0000 0000 0000 0000"
              maxlength="19"
              formControlName="numerotarjeta" />
            <small
              *ngIf="form.get('numerotarjeta')?.invalid && (form.get('numerotarjeta')?.touched || form.get('numerotarjeta')?.dirty)"
              style="color:#a12626;font-weight:700">
              {{ errors?.numero || 'Número de tarjeta inválido' }}
            </small>
          </div>

          <div class="field">
            <label for="venc">Vencimiento:</label>
            <!-- Mantiene MM/AA; el TS lo convierte a YYYY-MM-01 -->
            <input
              id="venc"
              type="text"
              inputmode="numeric"
              placeholder="MM/AA"
              maxlength="5"
              [value]="form.get('venc')?.value || ''"
              (input)="onVencInput($event)" />
            <small
              *ngIf="form.get('venc')?.invalid && (form.get('venc')?.touched || form.get('venc')?.dirty)"
              style="color:#a12626;font-weight:700">
              {{ errors?.venc || 'Vencimiento inválido (MM/AA)' }}
            </small>
          </div>

          <div class="field">
            <label for="cvv">CVV:</label>
            <input
              id="cvv"
              type="password"
              inputmode="numeric"
              placeholder="***"
              maxlength="4"
              formControlName="cvv" />
            <small
              *ngIf="form.get('cvv')?.invalid && (form.get('cvv')?.touched || form.get('cvv')?.dirty)"
              style="color:#a12626;font-weight:700">
              {{ errors?.cvv || 'CVV inválido' }}
            </small>
          </div>
        </div>

        <div class="actions">
          <button
            class="btn"
            id="enviar"
            type="button"
            (click)="onSubmit()"
            [disabled]="form.invalid || cargando">
            {{ cargando ? 'Procesando…' : 'Donar' }}
          </button>
        </div>

        <p *ngIf="mensajeError" style="color:#a12626;font-weight:700">{{ mensajeError }}</p>
        <p *ngIf="mensajeExito" style="color:#206d2f;font-weight:700">{{ mensajeExito }}</p>
      </div>

      <aside>
        <div class="summary">
          <h3>Resumen:</h3>
          <div class="amount" id="amountText">S/ {{ (form.get('monto')?.value || 0) | number:'1.2-2' }}</div>
          <div id="breakdown" style="margin-top:8px;color:#8a6a46;font-size:14px;"></div>
        </div>
      </aside>
    </div>

    <!-- Backdrop del modal -->
    <div class="modal-backdrop" *ngIf="receiptVisible" (click)="closeReceipt()" aria-hidden="true"></div>

    <!-- Modal del comprobante -->
    <div
      class="modal"
      *ngIf="receiptVisible"
      role="dialog"
      aria-modal="true"
      aria-labelledby="reciboTitle"
      (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 id="reciboTitle">Comprobante de donación:</h3>
        <button class="btn-close" type="button" (click)="closeReceipt()">Cerrar</button>
      </div>
      <div class="modal-body">
        <p><strong>Donante:</strong> {{ receipt.donante }}</p>
        <p><strong>Proyecto:</strong> {{ receipt.proyecto }}</p>
        <p><strong>Monto:</strong> S/ {{ receipt.monto | number:'1.2-2' }}</p>
        <p><strong>Método de pago:</strong> {{ receipt.metodo }}</p>
        <p><strong>Últimos 4 dígitos:</strong> ************{{ receipt.last4 }}</p>
        <p><strong>Fecha:</strong> {{ receipt.fecha }}</p>
        <p><strong>Estado:</strong> {{ receipt.estado }}</p>
      </div>
    </div>
  </section>
</main>




